<% content_for :title, "#{@disk.title} - #{@disk.artist} | Ruby On Records" %>

<% content_for :head do %>
  <% if @disk.cover.attached? %>
    <link rel="preload" as="image" href="<%= url_for(@disk.cover) %>">
  <% end %>
  <% @disk.photos.each do |photo| %>
    <link rel="preload" as="image" href="<%= url_for(photo) %>">
  <% end %>
<% end %>
<div>
  <article class="card-retro overflow-hidden">
    <div class="grid grid-cols-1 lg:grid-cols-2">
      <!-- Left Column - Carousel Portada -->
      <div class="bg-vinyl-black p-8 lg:p-12 flex flex-col items-center justify-center min-h-[400px] relative overflow-hidden group" data-controller="carousel">
        <div class="absolute inset-0 opacity-10" style="background-image: repeating-radial-gradient(circle at center, transparent 0, transparent 2px, rgba(255,255,255,.1) 2px, rgba(255,255,255,.1) 4px);"></div>
        
        <% 
          # Collect all images
          images = []
          if @disk.cover.attached?
            images << @disk.cover
          end
          if @disk.photos.attached?
            @disk.photos.each { |photo| images << photo }
          end
        %>
        
        <!-- Gallery Container -->
        <div class="w-full max-w-md mx-auto z-10">
          
          <!-- Main Image Display -->
          <div class="relative w-full aspect-square bg-vinyl-dark border-4 border-mustard shadow-2xl overflow-hidden mb-4 rounded-sm">
             <% if images.any? %>
               <%= image_tag images.first, 
                   class: "w-full h-full object-cover transition-opacity duration-300", 
                   id: "main-product-image",
                   data: { carousel_target: "mainImage" },
                   loading: "eager" %>
             <% else %>
               <!-- Fallback for no images -->
               <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-vinyl-black via-vinyl-dark to-vinyl-groove">
                 <% if @disk.format == 'CD' %>
                   <div class="w-2/3 h-2/3 cd-record vinyl-spin-hover"></div>
                 <% else %>
                   <div class="w-2/3 h-2/3 vinyl-record vinyl-spin-hover"></div>
                 <% end %>
               </div>
             <% end %>

            <!-- Bandera de Estado sobre la imagen principal -->
             <div class="absolute top-4 left-4 flex gap-2">
               <span class="badge-retro bg-cream text-vinyl-black"><%= @disk.format %></span>
               <span class="badge-retro bg-<%= @disk.state == 'Nuevo' ? 'teal' : 'sepia' %> text-cream"><%= @disk.state %></span>
             </div>
          </div>

          <!-- Thumbnails Grid -->
          <% if images.size > 1 %>
            <div class="flex flex-wrap justify-center gap-3 w-full">
              <% images.each do |image| %>
                <button type="button" 
                        class="w-16 h-16 sm:w-20 sm:h-20 border-2 border-vinyl-black overflow-hidden cursor-pointer transition-all opacity-70 hover:opacity-100 focus:outline-none"
                        data-action="click->carousel#select"
                        data-carousel-target="slide"
                        data-url="<%= url_for(image) %>">
                  <%= image_tag image, class: "w-full h-full object-cover" %>
                </button>
              <% end %>
            </div>
          <% end %>

        </div>
      </div>

      <!-- Right Column - Info -->
      <div class="p-8 lg:p-12 bg-paper">
        <!-- Title & Artist -->
        <div class="mb-6">
          <h1 class="font-display text-3xl sm:text-4xl lg:text-5xl font-bold text-vinyl-black leading-tight mb-3">
            <%= @disk.title %>
          </h1>
          <p class="text-xl sm:text-2xl text-sepia font-display">
            <%= @disk.artist %>
          </p>
        </div>
        
        <!-- Géneros (burbujas sutiles) -->
        <% if @disk.genres.any? %>
          <div class="flex flex-wrap gap-2 mb-6">
            <% @disk.genres.each do |genre| %>
              <%= link_to genre.genre_name, 
                  disks_path(genre_id: genre.id),
                  class: "inline-block px-3 py-1 text-xs font-medium rounded-full bg-vinyl-groove/20 text-vinyl-dark hover:bg-mustard/30 hover:text-vinyl-black transition-colors" %>
            <% end %>
          </div>
        <% end %>

        <!-- Description -->
        <% if @disk.description.present? %>
          <div class="mb-8">
            <p class="text-vinyl-dark leading-relaxed">
              <%= @disk.description %>
            </p>
          </div>
        <% end %>

        <!-- Details Grid -->
        <div class="grid grid-cols-2 gap-4 mb-8">
          <div class="bg-cream-dark p-4 border-2 border-vinyl-black">
            <span class="label-retro">Año</span>
            <p class="font-display text-2xl font-bold text-vinyl-black"><%= @disk.year %></p>
          </div>
          <div class="bg-cream-dark p-4 border-2 border-vinyl-black">
            <span class="label-retro">Formato</span>
            <p class="font-display text-2xl font-bold text-vinyl-black"><%= @disk.format %></p>
          </div>
          <div class="bg-cream-dark p-4 border-2 border-vinyl-black">
            <span class="label-retro">Estado</span>
            <p class="font-display text-2xl font-bold text-vinyl-black"><%= @disk.state %></p>
          </div>
          <div class="bg-cream-dark p-4 border-2 border-vinyl-black">
            <span class="label-retro">Stock</span>
            <p class="font-display text-2xl font-bold <%= @disk.stock > 0 ? 'text-teal' : 'text-rust' %>">
              <%= @disk.stock > 0 ? "#{@disk.stock} disp." : 'Agotado' %>
            </p>
          </div>
        </div>

        <!-- Price -->
        <div class="bg-vinyl-black text-cream p-6 mb-8 border-4 border-mustard">
          <div class="flex items-center justify-between">
            <span class="text-mustard uppercase tracking-wider font-bold">Precio</span>
            <span class="font-display text-4xl sm:text-5xl font-bold text-mustard">
              $<%= number_to_currency(@disk.price, unit: '', delimiter: '.', separator: ',', precision: 0) %>
            </span>
          </div>
        </div>

        <!-- Audio Preview (Solo Usados) -->
        <% if @disk.state == 'Usado' %>
          <div class="mb-8 p-4 bg-cream-dark border-2 border-vinyl-groove">
            <span class="label-retro mb-3 block">Preview</span>
            <% if @disk.preview.attached? %>
              <audio controls class="w-full">
                <source src="<%= url_for(@disk.preview) %>" type="<%= @disk.preview.content_type %>">
                Tu navegador no soporta audio.
              </audio>
            <% else %>
              <audio controls class="w-full">
                <source src="#" type="audio/mpeg">
                Tu navegador no soporta audio.
              </audio>
              <p class="text-sepia text-xs mt-2 italic">Audio de demostración próximamente</p>
            <% end %>
          </div>
        <% end %>

        <!-- Back Link -->
        <div class="mt-4 flex gap-4">
          <%= link_to disks_path, class: "inline-flex items-center gap-2 text-mustard-dark hover:text-mustard font-bold uppercase text-sm tracking-wider transition-colors" do %>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Volver al Catálogo
          <% end %>
        </div>
      </div>
    </div>
  </article>

</div>

<% if @related_disks.present? %>
  <section class="mt-16">
    <div class="divider-groovy"></div>
    <h2 class="font-display text-2xl lg:text-3xl font-bold text-vinyl-black mb-8 text-center uppercase tracking-wider">
      Tambien te podría gustar
    </h2>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
      <% @related_disks.each do |disk| %>
        <%= render 'shared/disk_card', disk: disk %>
      <% end %>
    </div>
  </section>
<% end %>
